<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Chris Hager"><meta name=description content="I&rsquo;m happy to introduce MicroPython-Ctl: a TypeScript library for talking to MicroPython devices (such as ESP32/8266, Raspberry Pi Pico, Pyboard, WiPy, and many more).
Use micropython-ctl to quickly build apps that interact with MicroPython devices: Websites / webapps, Node.js programs, Electron applications, Visual Studio Code extensions, Mobile apps (eg. with React Native) and more.
Connect to devices over serial or network interface Run Python scripts, receive the output Manipulate files and directories Terminal (REPL) interaction mctl command-line utility Mount MicroPython devices locally (with FUSE, experimental) Typed and fully async (you can use await with any command)."><meta name=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.metachris.dev/images/posts/micropython-ctl/landscape1.jpg"><meta name=twitter:title content="MicroPython-Ctl - a TypeScript library for talking to MicroPython devices"><meta name=twitter:description content="I&rsquo;m happy to introduce MicroPython-Ctl: a TypeScript library for talking to MicroPython devices (such as ESP32/8266, Raspberry Pi Pico, Pyboard, WiPy, and many more).
Use micropython-ctl to quickly build apps that interact with MicroPython devices: Websites / webapps, Node.js programs, Electron applications, Visual Studio Code extensions, Mobile apps (eg. with React Native) and more.
Connect to devices over serial or network interface Run Python scripts, receive the output Manipulate files and directories Terminal (REPL) interaction mctl command-line utility Mount MicroPython devices locally (with FUSE, experimental) Typed and fully async (you can use await with any command)."><meta property="og:title" content="MicroPython-Ctl - a TypeScript library for talking to MicroPython devices"><meta property="og:description" content="I&rsquo;m happy to introduce MicroPython-Ctl: a TypeScript library for talking to MicroPython devices (such as ESP32/8266, Raspberry Pi Pico, Pyboard, WiPy, and many more).
Use micropython-ctl to quickly build apps that interact with MicroPython devices: Websites / webapps, Node.js programs, Electron applications, Visual Studio Code extensions, Mobile apps (eg. with React Native) and more.
Connect to devices over serial or network interface Run Python scripts, receive the output Manipulate files and directories Terminal (REPL) interaction mctl command-line utility Mount MicroPython devices locally (with FUSE, experimental) Typed and fully async (you can use await with any command)."><meta property="og:type" content="article"><meta property="og:url" content="https://www.metachris.dev/2021/01/micropython-ctl-a-typescript-library-for-talking-to-micropython-devices/"><meta property="og:image" content="https://www.metachris.dev/images/posts/micropython-ctl/landscape1.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-29T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-29T00:00:00+00:00"><base href=https://www.metachris.dev/2021/01/micropython-ctl-a-typescript-library-for-talking-to-micropython-devices/><title>MicroPython-Ctl - a TypeScript library for talking to MicroPython devices ¬∑ Chris Hager
</title><link rel=canonical href=https://www.metachris.dev/2021/01/micropython-ctl-a-typescript-library-for-talking-to-micropython-devices/><link rel=stylesheet href=https://www.metachris.dev/css/normalize.min.css><link rel=stylesheet href=https://www.metachris.dev/css/coder.min.087f88b919266fd3539233cb20d5badb7d38a036ceb897bf29703f6c8d92517d.css integrity="sha256-CH+IuRkmb9NTkjPLINW62304oDbOuJe/KXA/bI2SUX0=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://www.metachris.dev/css/coder-dark.min.555a1ef52d640ac2e953517fb98e13f034f07996d15b0efd41f0c2cb15932293.css integrity="sha256-VVoe9S1kCsLpU1F/uY4T8DTweZbRWw79QfDCyxWTIpM=" crossorigin=anonymous media=screen><script src=https://www.metachris.dev/js/custom.js></script><link rel=stylesheet href=https://www.metachris.dev/scss/custom.min.c9518cff7b36b562428295879b87d4f53d132d5f02aff0b3ef387655438ec3cd.css integrity="sha256-yVGM/3s2tWJCgpWHm4fU9T0TLV8Cr/Cz7zh2VUOOw80=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://www.metachris.dev/images/favicon-32px.png sizes=32x32><link rel=icon type=image/png href=https://www.metachris.dev/images/favicon-16px.png sizes=16x16><link rel=alternate type=application/rss+xml href=https://www.metachris.devindex.xml title="Site Title"></head><body class=colorscheme-auto><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://www.metachris.dev/>Chris Hager
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><svg width="20" height="20" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/></svg></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://www.metachris.dev/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://www.metachris.dev/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=https://www.metachris.dev/projects/>Projects</a></li><li class=navigation-item><a id=dark-mode-toggle class=colorscheme-toggle title="Toggle light/dark theme" style=cursor:pointer><span id=theme-icon>üåô</span></a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>MicroPython-Ctl - a TypeScript library for talking to MicroPython devices</h1></div><div class=post-meta><div class=date><span class=posted-on><time datetime=2021-01-29T00:00:00Z>January 2021</time></span></div></div></header><div class=single-content><p>I&rsquo;m happy to introduce <strong><a href=https://github.com/metachris/micropython-ctl>MicroPython-Ctl</a></strong>: a TypeScript library for talking to <a href=http://micropython.org/>MicroPython</a> devices (such as <a href=https://en.wikipedia.org/wiki/ESP32>ESP32</a>/<a href=https://en.wikipedia.org/wiki/ESP8266>8266</a>, <a href=https://www.raspberrypi.org/documentation/pico/getting-started/>Raspberry Pi Pico</a>, <a href=https://pyboard.org/>Pyboard</a>, <a href=https://pycom.io/product/wipy-3-0/>WiPy</a>, and many more).</p><div style=float:right;max-width:200px><img src=https://www.metachris.dev/images/posts/micropython-ctl/portrait1.png class=top-esp32></div><p>Use <code>micropython-ctl</code> to quickly build apps that interact with MicroPython devices: Websites / webapps, Node.js programs, <a href=https://www.electronjs.org/>Electron</a> applications, <a href=https://code.visualstudio.com/api/get-started/your-first-extension>Visual Studio Code extensions</a>, Mobile apps (eg. with <a href=https://reactnative.dev/>React Native</a>) and more.</p><ul><li>Connect to devices over serial or network interface</li><li>Run Python scripts, receive the output</li><li>Manipulate files and directories</li><li>Terminal (REPL) interaction</li><li><a href=https://github.com/metachris/micropython-ctl/tree/master/cli><code>mctl</code></a> command-line utility</li><li>Mount MicroPython devices locally (with FUSE, experimental)</li><li>Typed and fully async (you can use <code>await</code> with any command).</li><li>Works on Linux, macOS and Windows</li></ul><p>You can see all the features in the <a href=https://metachris.github.io/micropython-ctl/index.html>documentation</a>, <a href=https://github.com/metachris/micropython-ctl/tree/master/examples>examples</a> and <a href=https://github.com/metachris/micropython-ctl/blob/master/cli><code>cli/</code></a>.</p><h3 id=installation>Installation</h3><p>For Node.js and Electron, install <a href=https://github.com/metachris/micropython-ctl><code>micropython-ctl</code></a> from <a href=https://www.npmjs.com/package/micropython-ctl>npm</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Install with yarn</span>
</span></span><span style=display:flex><span>$ yarn add micropython-ctl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># or with npm</span>
</span></span><span style=display:flex><span>$ npm install micropython-ctl
</span></span></code></pre></div><p>To use it in the browser, include <a href=https://github.com/metachris/micropython-ctl><code>micropython-ctl</code></a> like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>script</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://cdn.jsdelivr.net/npm/micropython-ctl@1.10.0/dist-browser/main.js&#34;</span>&gt;&lt;/<span style=color:#f92672>script</span>&gt;
</span></span></code></pre></div><h3 id=usage-example>Usage example</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>micropython</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MicroPythonDevice</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Connect to micropython device over network
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>micropython</span>.<span style=color:#a6e22e>connectNetwork</span>(<span style=color:#e6db74>&#39;DEVICE_IP&#39;</span>, <span style=color:#e6db74>&#39;WEBREPL_PASSWORD&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Or connect to micropython device over serial interface
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>micropython</span>.<span style=color:#a6e22e>connectSerial</span>(<span style=color:#e6db74>&#39;/dev/ttyUSB0&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Run a Python script and capture the output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>output</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>micropython</span>.<span style=color:#a6e22e>runScript</span>(<span style=color:#e6db74>&#39;print(&#34;Hello world&#34;)&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;runScript output:&#39;</span>, <span style=color:#a6e22e>output</span>)  <span style=color:#75715e>// -&gt; Hello world
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// List all files in the root
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>files</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>micropython</span>.<span style=color:#a6e22e>listFiles</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;files:&#39;</span>, <span style=color:#a6e22e>files</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>/* [
</span></span></span><span style=display:flex><span><span style=color:#75715e>  { filename: &#39;/boot.py&#39;, size: 31, isDir: false },
</span></span></span><span style=display:flex><span><span style=color:#75715e>  { filename: &#39;/files&#39;, size: 0, isDir: true }
</span></span></span><span style=display:flex><span><span style=color:#75715e>] */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Get information about the board:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>boardInfo</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>micropython</span>.<span style=color:#a6e22e>getBoardInfo</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>boardInfo</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>/* {
</span></span></span><span style=display:flex><span><span style=color:#75715e>    sysname: &#39;esp32&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    nodename: &#39;esp32&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    release: &#39;1.13.0&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    version: &#39;v1.13 on 2020-09-02&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    machine: &#39;ESP32 module with ESP32&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    uniqueId: &#39;c44f3312f529&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    memFree: 108736,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    fsBlockSize: 4096,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    fsBlocksTotal: 512,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    fsBlocksFree: 438
</span></span></span><span style=display:flex><span><span style=color:#75715e>} */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Set a terminal (REPL) data handler, and send data to the REPL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>micropython</span>.<span style=color:#a6e22e>onTerminalData</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>data</span>) =&gt; <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>stdout</span>.<span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>micropython</span>.<span style=color:#a6e22e>sendData</span>(<span style=color:#e6db74>&#39;\x03\x02&#39;</span>)  <span style=color:#75715e>// Ctrl+C and Ctrl+B to enter friendly repl and print version
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Trigger a hard reset of the device
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>await</span> <span style=color:#a6e22e>micropython</span>.<span style=color:#a6e22e>reset</span>()
</span></span></code></pre></div><p>See also:</p><ul><li><a href=https://metachris.github.io/micropython-ctl/index.html>Documentation</a></li><li><a href=https://github.com/metachris/micropython-ctl/tree/master/examples>Examples</a></li><li><a href=https://github.com/metachris/micropython-ctl/blob/master/cli><code>mctl</code> cli</a></li></ul><h3 id=mctl>mctl</h3><p><a href=https://github.com/metachris/micropython-ctl/tree/master/cli><code>mctl</code></a> is the accompanying cli tool, to interact with a MicroPython device from your terminal:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># Install</span>
</span></span><span style=display:flex><span>$ npm install -g micropython-ctl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Print the help</span>
</span></span><span style=display:flex><span>$ mctl help
</span></span><span style=display:flex><span>Usage: index <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>command<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  -t, --tty &lt;device&gt;                            Connect over serial interface <span style=color:#f92672>(</span>eg. /dev/tty.SLAB_USBtoUART<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  -h, --host &lt;host&gt;                             Connect over network to hostname or IP of device
</span></span><span style=display:flex><span>  -p, --password &lt;password&gt;                     Password <span style=color:#66d9ef>for</span> network device
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Commands:
</span></span><span style=display:flex><span>  devices                                       List serial devices
</span></span><span style=display:flex><span>  repl                                          Open a REPL terminal
</span></span><span style=display:flex><span>  run &lt;fileOrCommand&gt;                           Execute a Python file or command
</span></span><span style=display:flex><span>  info <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span>                                Get information about the board <span style=color:#f92672>(</span>versions, unique id, space, memory<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  ls <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>directory<span style=color:#f92672>]</span>                      List files on a device
</span></span><span style=display:flex><span>  cat &lt;filename&gt;                                Print content of a file on the device
</span></span><span style=display:flex><span>  get &lt;file_or_dirname&gt; <span style=color:#f92672>[</span>out_file_or_dirname<span style=color:#f92672>]</span>   Download a file or directory from the device. Download everything with <span style=color:#e6db74>&#39;get /&#39;</span>
</span></span><span style=display:flex><span>  put &lt;file_or_dirname&gt; <span style=color:#f92672>[</span>dest_file_or_dirname<span style=color:#f92672>]</span>  Upload a file or directory onto the device
</span></span><span style=display:flex><span>  edit &lt;filename&gt;                               Edit a file, and <span style=color:#66d9ef>if</span> changed upload afterwards
</span></span><span style=display:flex><span>  mkdir &lt;name&gt;                                  Create a directory
</span></span><span style=display:flex><span>  rm <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> &lt;path&gt;                           Delete a file or directory
</span></span><span style=display:flex><span>  mv &lt;oldPath&gt; &lt;newPath&gt;                        Rename a file or directory
</span></span><span style=display:flex><span>  sha256 &lt;filename&gt;                             Get the SHA256 hash of a file
</span></span><span style=display:flex><span>  reset <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span>                               Reset the MicroPython device
</span></span><span style=display:flex><span>  mount <span style=color:#f92672>[</span>targetPath<span style=color:#f92672>]</span>                            Mount a MicroPython device <span style=color:#f92672>(</span>over serial or network<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  version                                       Print the version of mctl
</span></span><span style=display:flex><span>  help <span style=color:#f92672>[</span>command<span style=color:#f92672>]</span>                                display help <span style=color:#66d9ef>for</span> command
</span></span></code></pre></div><p>Examples:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># List serial devices</span>
</span></span><span style=display:flex><span>$ mctl devices
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get information about the board</span>
</span></span><span style=display:flex><span>$ mctl info
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Enter the REPL</span>
</span></span><span style=display:flex><span>$ mctl repl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># List files</span>
</span></span><span style=display:flex><span>$ mctl ls -r
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Print contents of boot.py</span>
</span></span><span style=display:flex><span>$ mctl cat boot.py
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Mount the device (experimental, doesn&#39;t handle binary files well)</span>
</span></span><span style=display:flex><span>$ mctl mount
</span></span></code></pre></div><h3 id=links--references>Links & References</h3><ul><li><a href=https://github.com/metachris/micropython-ctl>Github: micropython-ctl</a></li><li><a href=https://metachris.github.io/micropython-ctl/>Documentation</a></li><li><a href=https://www.npmjs.com/package/micropython-ctl>npm</a></li><li><a href=https://github.com/metachris/micropython-ctl/tree/master/examples>Examples</a></li><li><a href=https://github.com/metachris/micropython-ctl/tree/master/cli><code>mctl</code> command line tool</a></li></ul><br><hr><p>I think MicroPython is a wonderful project, in particular for education and rapid prototyping. I hope this library is a small addition to the MicroPython ecosystem, making it easier
to use build apps that interact with live devices!</p><p>bringing everything together as a fully working first release took way longer than I anticipated, and I&rsquo;m very happy that it&rsquo;s finally arrived.
I hope you enjoy using it for building things! If you do, let me know.</p><p>Feel free to reach out: <a href=mailto:chris@linuxuser.at>chris@linuxuser.at</a> / <a href=https://twitter.com/metachris>twitter.com/metachris</a>. I&rsquo;d love hearing from you.</p><hr><h3 id=background>Background</h3><p>I&rsquo;ve playing with <a href=http://micropython.org/>MicroPython</a> for several small projects in recent months, and wanted a better way to interface with MicroPython over the network,
in particular for websites and Electron applications. I looked into the the official reference <a href=https://github.com/micropython/webrepl>webrepl implementations</a>
and started writing some code on the off evenings.</p><p>And here we are, after a major push around Christmas to wrap the prototyping up into a usable module. As is typical, the &ldquo;only last few bits&rdquo; end up being quite a lot of small and medium things, let alone platform compatibility and creating testsuites which in turn discovered a few more issues.</p><p>All in all I spent way too much time on this. But the prototype was already so far along, and I wanted to get it to a state so that people can actually use this too.</p><p>And now I&rsquo;m really happy that this point is reached! :)</p><hr><h3 id=rabbit-holes--challenges>Rabbit holes & Challenges</h3><p>There have been various challenges and rabbitholes, and I wanted to give some of them a honorable mention.</p><h5 id=implementing-the-replwebrepl-protocol>Implementing the REPL/WebREPL protocol</h5><p>The primary challenge was implementing the MicroPython protocol, and making the library work with both serial and the network connections.</p><p>To start, there are several REPL modes:</p><ol><li>The friendly REPL that&rsquo;s typically used when connecting to MicroPython. It prints all entered characters and the script output back to you.</li><li>The RAW REPL: You can enter it with Ctrl+A, send scripts there (characters are not printed back), and then have the script execute.
The standard output and error output can then be collected. See the <a href=https://github.com/metachris/micropython-ctl/blob/master/src/main.ts#L463>code here</a>.
The Raw REPL mode is used for executing scripts.</li><li>There is a <a href=https://github.com/micropython/micropython/blob/master/docs/reference/repl.rst#raw-mode-and-raw-paste-mode>new raw-paste mode</a> coming that might be interesting to support.</li></ol><p>Furthermore there are a number of commands specific to WebREPL connections: <code>GET_VER</code>, <code>PUT_FILE</code> and <code>GET_FILE</code>.</p><p>The reference implementations in the <a href=https://github.com/micropython/webrepl>micropython/webrepl repository</a> were very helpful.</p><h5 id=making-everything-awaitable>Making everything await&rsquo;able</h5><p>One of the challenges is making commands (and <code>runScript(..)</code>) asynchronous, so users can use <code>await</code> to wait for the collected output of the command.
This is accomplished by creating, storing and returning a Promise that is resolved or rejected at a later time when the matching response has been received.</p><p>See code <a href=https://github.com/metachris/micropython-ctl/blob/master/src/main.ts#L198>here</a> and <a href=https://github.com/metachris/micropython-ctl/blob/master/src/main.ts#L489>here</a>.</p><h5 id=implementing-commands-for-limited-system-resources>Implementing commands for limited system resources</h5><p>MicroPython devices have pretty limited resources, in particular memory and a slow network connection.
It&rsquo;s important to work with these constraints when implementing commands:</p><ul><li>Sending scripts in chunks with delays (I&rsquo;ve arrived at the correct <a href=https://github.com/metachris/micropython-ctl/blob/master/src/main.ts#L581>chunksize and delays</a> by trial and error)</li><li>Uploading files: we don&rsquo;t want to send the whole file at once since it may be larger than the available memory. The solution is to write the data in chunks (see <a href=https://github.com/metachris/micropython-ctl/blob/master/src/main.ts#L801>code here</a>)</li><li>Files content is uploaded hex-encoded (in Node: <code>data.toString('hex')</code>) and written to the file in binary (Python: <code>f.write(ubinascii.unhexlify(chunk))</code>) (see <a href=https://github.com/metachris/micropython-ctl/blob/master/src/main.ts#L800>code here</a>)</li></ul><p>It was great to have reference implementations from tools such as <a href=https://github.com/micropython/webrepl>webrepl</a>, <a href=https://github.com/scientifichackers/ampy/>ampy</a> and <a href=https://github.com/dhylands/rshell>rshell</a>.</p><h5 id=creating-bundles-for-nodejs-and-browsers>Creating bundles for Node.js and browsers</h5><p>I wanted the same codebase to work for both Node.js and browsers. The Node.js module is built using TypeScript (<a href=https://github.com/metachris/micropython-ctl/blob/master/tsconfig.json>config file here</a>), and the browser module using <a href=https://webpack.js.org/>webpack</a> (<a href=https://github.com/metachris/micropython-ctl/blob/master/webpack.config.js>config file here</a>).</p><p>Code-wise this had several implications:</p><ul><li>Different WebSocket implementations across browser and Node.js. Solved by using <a href=https://github.com/heineiuo/isomorphic-ws>isomorphic-ws</a>.</li><li><a href=https://nodejs.org/api/buffer.html><code>Buffer</code></a> is not available natively in the browser. Solved by using <a href=https://www.npmjs.com/package/buffer>https://www.npmjs.com/package/buffer</a>.</li><li>Serial interfaces are inaccessible in the browser. Solved by including <a href=http://serialport.io/><code>serialport</code></a> conditionally (<a href=https://github.com/metachris/micropython-ctl/blob/master/src/main.ts#L215>code here</a>) and marking it as an <a href=https://webpack.js.org/configuration/externals/><code>external</code> in webpack</a> (<a href=https://github.com/metachris/micropython-ctl/blob/master/webpack.config.js#L20>code here</a>).</li></ul><h5 id=mounting-the-device-into-the-filesystem-using-fuse>Mounting the device into the filesystem (using FUSE)</h5><p>Mounting a virtual filesystem in Node.js is a mess! Using FUSE is generally the way to go, but there are no maintained Node.js bindings :(</p><ul><li>Previously you&rsquo;d have used <a href=https://github.com/mafintosh/fuse-bindings>https://github.com/mafintosh/fuse-bindings</a>, but this library is neither maintained nor compatible with Node.js > 10.</li><li>Development has officially moved on to <a href=https://github.com/fuse-friends/fuse-native>https://github.com/fuse-friends/fuse-native</a></li><li><code>fuse-native</code> works almost well on macOS and Linux, just that it doesn&rsquo;t seem possible to return binary data (only printable string characters work, see <a href=https://github.com/fuse-friends/fuse-native/issues/30>this issue</a>). And no support for Windows. And doesn&rsquo;t seem actively developed anymore.</li><li>On Windows the most recent development is in <a href=https://github.com/direktspeed/node-fuse-bindings>https://github.com/direktspeed/node-fuse-bindings</a>, which uses <a href=https://github.com/dokan-dev/dokany/wiki/Installation>Dokany</a> as FUSE driver. It is possible to mount a virtual filesystem, but for me it crashes on reading from a file (see <a href=https://github.com/direktspeed/node-fuse-bindings/issues/11>this issue</a>). Also it doesn&rsquo;t seem actively developed anymore.</li><li>You can find the FUSE bindings <a href=https://github.com/metachris/micropython-ctl/blob/master/cli/mount-device.ts>code here</a>.</li></ul><p>It was an interesting experiment to mount the MicroPython device on the local filesystem, but ultimately it doesn&rsquo;t seem good enough with the current state of the Node.js FUSE bindings.</p><p>An interesting thing here is that I didn&rsquo;t want to include the fuse bindings libraries by default, so whenever <code>mctl mount</code> is called, it checks if the bindings are installed, and if not asks to install it then. See <a href=https://github.com/metachris/micropython-ctl/blob/master/cli/fuse-dependencies.ts>code here</a>.</p><p>You can experimentally mount the MicroPython device onto your local filesystem with <code>mctl mount</code>, see <a href=https://github.com/metachris/micropython-ctl/tree/master/cli>more here</a>. It should work with <code>.py</code> files, but
downloading binary files will probably not work.</p><h5 id=electron>Electron</h5><p>Electron discourages to use Node.js integration in renderers (<a href=https://www.electronjs.org/docs/tutorial/security#2-do-not-enable-nodejs-integration-for-remote-content>see here</a>).
Therefore the SerialPort module needs to be <a href=https://stackoverflow.com/questions/57807459/how-to-use-preload-js-properly-in-electron>preloaded</a> and attached as <code>window.SerialPort</code> like this (<code>preload.js</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>window.<span style=color:#a6e22e>SerialPort</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;serialport&#39;</span>);
</span></span></code></pre></div><h5 id=testing>Testing</h5><p>I invested more and more time in testsuites that can be run automatically to test the major functionality of the library (see <a href=https://github.com/metachris/micropython-ctl/blob/master/tests/testsuite.ts>testsuite.ts</a>).</p><p>To test cross-platform compatibility, I&rsquo;ve spun up a few VirtualBox VMs, especially Windows 10 and Ubuntu Linux. I&rsquo;m mounting the project directory and run the tests in there as well.
Finally this is easy for Windows as well, with the <a href=https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/>VM images provided by Microsoft</a>.</p><p>The tests run in about 6 seconds when using the serial interface, and about 50 seconds when using the network connection</p><p>I&rsquo;d like to run the tests in CI, but they need an attached MicroPython device (the local build of MicroPython doesn&rsquo;t support a terminal or webrepl).
A workaround might be to run a telnet server on the MicroPython instance and have MicroPython-Ctl connect to that.</p><p>Needs further investigation.</p><hr><p>Send feedback & comments to <a href=https://twitter.com/metachris>twitter.com/metachris</a>, or create an issue in the <a href=https://github.com/metachris/micropython-ctl/>micropython-ctl repository</a>.</p><p>üôè</p></div><hr><div style=height:14px></div><div style=float:right></div><div style=clear:both></div><div class=bottomAbout style=display:flex><div style=flex-grow:2><script async src=https://platform.twitter.com/widgets.js></script><a href=https://twitter.com/share class=twitter-share-button data-show-count=false>Tweet</a><br><a href=https://twitter.com/metachris class=twitter-follow-button data-show-count=false>Follow @metachris</a></div><div style=margin-top:0><a href=https://twitter.com/metachris><img src=https://www.metachris.dev/images/profile2-round.png alt=Chris class=profile style=max-width:60px></a></div></div><hr><div class=bottom-post-links><div class=prev><span class=title>OLDER POST</span><br><a href=https://www.metachris.dev/2020/10/a-new-version-of-logzero-is-released-v1.6/>A new version of logzero is released (v1.6) üéâ</a></div><div class=next><span class=title>NEWER POST</span><br><a href=https://www.metachris.dev/2021/03/bootstrapping-a-typescript-node.js-project/>Starting a TypeScript Project in 2021</a></div></div><footer><a id=comments></a><script src=https://utteranc.es/client.js repo=metachris/metachris.dev-comments issue-term=og:title theme=preferred-color-scheme crossorigin=anonymous async></script></footer></article></section></div><footer class=footer><section class=container></section></footer></main><script src=https://www.metachris.dev/js/dark-mode.min.6948493aa1da5fe4e63b34961a67cde1361353b72c9e2d61f024a34872147559.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-168016633-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-168016633-1")</script></body></html>